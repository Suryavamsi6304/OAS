<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proctoring Logs - Teacher</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3>Teacher Panel</h3>
            </div>
            <ul class="nav-links">
                <li><a href="teacher-dashboard.html">Dashboard</a></li>
                <li><a href="teacher-assessments.html">Assessments</a></li>
                <li><a href="teacher-create.html">Create Test</a></li>
                <li><a href="teacher-proctoring.html" class="active">Proctoring Logs</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="content-header">
                <h1>Proctoring Logs</h1>
                <button onclick="Auth.logout()" class="btn-logout">Logout</button>
            </div>

            <div class="content-section">
                <div class="proctoring-header">
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="assessmentFilter">Filter by Assessment:</label>
                            <select id="assessmentFilter" onchange="filterLogs()" class="filter-select">
                                <option value="">All Assessments</option>
                            </select>
                        </div>
                        <button onclick="loadLogs()" class="btn-refresh">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid modern">
                    <div class="stat-card sessions">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3 id="totalSessions">0</h3>
                            <p>Total Sessions</p>
                        </div>
                    </div>
                    <div class="stat-card violations">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-info">
                            <h3 id="totalViolations">0</h3>
                            <p>Total Violations</p>
                        </div>
                    </div>
                    <div class="stat-card high-risk">
                        <div class="stat-icon">üö®</div>
                        <div class="stat-info">
                            <h3 id="highRiskStudents">0</h3>
                            <p>High Risk Students</p>
                        </div>
                    </div>
                    <div class="stat-card active">
                        <div class="stat-icon">üî¥</div>
                        <div class="stat-info">
                            <h3 id="activeSessions">0</h3>
                            <p>Active Sessions</p>
                        </div>
                    </div>
                </div>

                <div class="proctoring-table-container">
                    <div class="table-header">
                        <h3>üìä Proctoring Sessions</h3>
                        <div class="table-actions">
                            <button onclick="exportLogs()" class="btn-export">üì• Export</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="proctoring-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Assessment</th>
                                    <th>Session Details</th>
                                    <th>Status</th>
                                    <th>Violations</th>
                                    <th>Risk Level</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logsTable">
                                <tr>
                                    <td colspan="7" class="loading-row">
                                        <div class="loading-spinner"></div>
                                        <span>Loading proctoring data...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Violation Details Modal -->
            <div id="violationModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <h2>Violation Details</h2>
                    <div id="violationDetails"></div>
                </div>
            </div>
        </main>
    </div>

    <style>
        .proctoring-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .filter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #333;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stats-grid.modern {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card.sessions {
            border-left: 4px solid #007bff;
        }
        
        .stat-card.violations {
            border-left: 4px solid #ffc107;
        }
        
        .stat-card.high-risk {
            border-left: 4px solid #dc3545;
        }
        
        .stat-card.active {
            border-left: 4px solid #28a745;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        
        .stat-info h3 {
            font-size: 2rem;
            margin: 0;
            color: #333;
        }
        
        .stat-info p {
            margin: 5px 0 0 0;
            color: #666;
            font-weight: 500;
        }
        
        .proctoring-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .btn-export {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        .proctoring-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .proctoring-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }
        
        .proctoring-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        
        .proctoring-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .loading-row {
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .student-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .student-name {
            font-weight: 600;
            color: #333;
        }
        
        .student-email {
            font-size: 0.9rem;
            color: #666;
        }
        
        .session-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .session-time {
            font-size: 0.9rem;
            color: #666;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }
        
        .badge.success { background: #d4edda; color: #155724; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: #721c24; }
        .badge.info { background: #d1ecf1; color: #0c5460; }
        
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .risk-bar {
            width: 60px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .risk-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .risk-fill.low { background: #28a745; }
        .risk-fill.medium { background: #ffc107; }
        .risk-fill.high { background: #fd7e14; }
        .risk-fill.critical { background: #dc3545; }
        
        .btn-view-details {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .btn-view-details:hover {
            background: #0056b3;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .violation-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .violation-type {
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .violation-time {
            font-size: 0.9rem;
            color: #666;
        }
    </style>
    <script src="js/auth.js"></script>
    <script>
        let allLogs = [];
        let assessments = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.requireAuth() || !Auth.hasRole('teacher')) {
                window.location.href = 'teacher-dashboard.html';
                return;
            }

            await loadAssessments();
            await loadLogs();
        });

        async function loadAssessments() {
            try {
                const response = await fetch(`http://${window.location.hostname}:3000/api/assessments`, {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });
                
                if (!response.ok) {
                    console.error('Failed to load assessments:', response.status);
                    return;
                }
                
                assessments = await response.json();
                console.log('Loaded assessments:', assessments);
                
                const select = document.getElementById('assessmentFilter');
                if (assessments && assessments.length > 0) {
                    assessments.forEach(assessment => {
                        const option = document.createElement('option');
                        option.value = assessment.id;
                        option.textContent = assessment.title;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No assessments found';
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load assessments:', error);
            }
        }

        async function loadLogs() {
            try {
                const assessmentId = document.getElementById('assessmentFilter').value;
                const url = assessmentId ? 
                    `http://${window.location.hostname}:3000/api/proctoring/logs?assessmentId=${assessmentId}` :
                    `http://${window.location.hostname}:3000/api/proctoring/logs`;

                console.log('Loading logs from:', url);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                allLogs = await response.json();
                console.log('Loaded logs:', allLogs);
                
                // If no real data, show sample data for demonstration
                if (!allLogs || allLogs.length === 0) {
                    allLogs = [
                        {
                            session_id: 1,
                            student_name: 'Demo Student',
                            student_email: 'demo@student.com',
                            assessment_title: 'Sample Assessment',
                            start_time: new Date(Date.now() - 3600000).toISOString(),
                            end_time: new Date().toISOString(),
                            status: 'completed',
                            total_violations: 2,
                            risk_score: 15,
                            violation_type: 'tab_switch',
                            severity: 'medium',
                            description: 'Student switched tabs during test',
                            violation_time: new Date(Date.now() - 1800000).toISOString()
                        }
                    ];
                }
                
                displayLogs();
                updateStats();
            } catch (error) {
                console.error('Failed to load proctoring logs:', error);
                document.getElementById('logsTable').innerHTML = 
                    `<tr><td colspan="7" class="loading-row">Error: ${error.message}</td></tr>`;
            }
        }

        function displayLogs() {
            const tbody = document.getElementById('logsTable');
            
            if (allLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading-row">No proctoring sessions found</td></tr>';
                return;
            }

            // Group logs by session
            const sessions = {};
            allLogs.forEach(log => {
                if (!sessions[log.session_id]) {
                    sessions[log.session_id] = {
                        ...log,
                        violations: []
                    };
                }
                if (log.violation_type) {
                    sessions[log.session_id].violations.push({
                        type: log.violation_type,
                        severity: log.severity,
                        description: log.description,
                        time: log.violation_time
                    });
                }
            });

            tbody.innerHTML = Object.values(sessions).map(session => {
                const riskLevel = session.risk_score < 10 ? 'low' : session.risk_score < 25 ? 'medium' : session.risk_score < 50 ? 'high' : 'critical';
                const riskWidth = Math.min((session.risk_score / 50) * 100, 100);
                
                return `
                    <tr>
                        <td>
                            <div class="student-info">
                                <div class="student-name">${session.student_name}</div>
                                <div class="student-email">${session.student_email}</div>
                            </div>
                        </td>
                        <td><strong>${session.assessment_title || 'Unknown Assessment'}</strong></td>
                        <td>
                            <div class="session-details">
                                <div class="session-time">üìÖ ${new Date(session.start_time).toLocaleString()}</div>
                                <div class="session-time">‚è±Ô∏è ${session.end_time ? new Date(session.end_time).toLocaleString() : 'Ongoing'}</div>
                                <div class="session-time">‚è≥ ${session.end_time ? Math.round((new Date(session.end_time) - new Date(session.start_time)) / 60000) + ' min' : 'In progress'}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${session.status === 'completed' ? 'success' : session.status === 'active' ? 'warning' : 'danger'}">
                                ${session.status.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${session.total_violations === 0 ? 'success' : session.total_violations < 3 ? 'warning' : 'danger'}">
                                ‚ö†Ô∏è ${session.total_violations}
                            </span>
                        </td>
                        <td>
                            <div class="risk-indicator">
                                <div class="risk-bar">
                                    <div class="risk-fill ${riskLevel}" style="width: ${riskWidth}%"></div>
                                </div>
                                <span class="badge ${riskLevel === 'low' ? 'success' : riskLevel === 'medium' ? 'warning' : 'danger'}">
                                    ${session.risk_score}
                                </span>
                            </div>
                        </td>
                        <td>
                            <button class="btn-view-details" onclick="viewViolations(${session.session_id})">
                                üìã View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            const sessions = {};
            allLogs.forEach(log => {
                sessions[log.session_id] = log;
            });

            const sessionList = Object.values(sessions);
            const totalSessions = sessionList.length;
            const totalViolations = sessionList.reduce((sum, s) => sum + s.total_violations, 0);
            const highRiskStudents = sessionList.filter(s => s.risk_score > 25).length;
            const activeSessions = sessionList.filter(s => s.status === 'active').length;

            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('totalViolations').textContent = totalViolations;
            document.getElementById('highRiskStudents').textContent = highRiskStudents;
            document.getElementById('activeSessions').textContent = activeSessions;
        }

        function filterLogs() {
            loadLogs();
        }

        function viewViolations(sessionId) {
            const sessionLogs = allLogs.filter(log => log.session_id === sessionId);
            const violations = sessionLogs.filter(log => log.violation_type);
            
            const modal = document.getElementById('violationModal');
            const details = document.getElementById('violationDetails');
            
            if (violations.length === 0) {
                details.innerHTML = `
                    <div class="violation-summary">
                        <h3>üë§ ${sessionLogs[0].student_name}</h3>
                        <p><strong>Assessment:</strong> ${sessionLogs[0].assessment_title}</p>
                        <p><strong>Session Status:</strong> <span class="badge success">Clean Session</span></p>
                        <p style="color: #28a745; margin-top: 20px;">‚úÖ No violations recorded for this session.</p>
                    </div>
                `;
            } else {
                details.innerHTML = `
                    <div class="violation-summary">
                        <h3>üë§ ${sessionLogs[0].student_name}</h3>
                        <p><strong>Assessment:</strong> ${sessionLogs[0].assessment_title}</p>
                        <p><strong>Total Violations:</strong> <span class="badge danger">${violations.length}</span></p>
                        <p><strong>Risk Score:</strong> <span class="badge ${sessionLogs[0].risk_score > 25 ? 'danger' : 'warning'}">${sessionLogs[0].risk_score}</span></p>
                    </div>
                    <div class="violations-list">
                        <h4>üö® Violation Details</h4>
                        ${violations.map(v => `
                            <div class="violation-item" style="border-left: 4px solid ${getSeverityColor(v.severity)};">
                                <div class="violation-header">
                                    <div class="violation-type">${v.violation_type.replace(/_/g, ' ')}</div>
                                    <span class="badge ${v.severity}">${v.severity.toUpperCase()}</span>
                                </div>
                                <p style="margin: 8px 0; color: #555;">${v.description}</p>
                                <div class="violation-time">üï∞Ô∏è ${new Date(v.violation_time).toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }
        
        function exportLogs() {
            if (allLogs.length === 0) {
                alert('No data to export');
                return;
            }
            
            const sessions = {};
            allLogs.forEach(log => {
                if (!sessions[log.session_id]) {
                    sessions[log.session_id] = { ...log, violations: [] };
                }
                if (log.violation_type) {
                    sessions[log.session_id].violations.push({
                        type: log.violation_type,
                        severity: log.severity,
                        description: log.description,
                        time: log.violation_time
                    });
                }
            });
            
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Student Name,Email,Assessment,Start Time,End Time,Status,Total Violations,Risk Score,Violation Details\n" +
                Object.values(sessions).map(session => {
                    const violationDetails = session.violations.map(v => `${v.type}(${v.severity})`).join('; ');
                    return `"${session.student_name}","${session.student_email}","${session.assessment_title}","${session.start_time}","${session.end_time || 'Ongoing'}","${session.status}","${session.total_violations}","${session.risk_score}","${violationDetails}"`;
                }).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `proctoring_logs_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getSeverityColor(severity) {
            switch(severity) {
                case 'low': return '#28a745';
                case 'medium': return '#ffc107';
                case 'high': return '#fd7e14';
                case 'critical': return '#dc3545';
                default: return '#6c757d';
            }
        }

        function closeModal() {
            document.getElementById('violationModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('violationModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>