<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <img src="images/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none'">
        </div>
        <ul class="nav-menu">
            <li><a href="admin-dashboard.html">üè† Home</a></li>
            <li><a href="admin-users.html">üë• User Management</a></li>
            <li><a href="admin-assessments.html">üìù Assessment Management</a></li>
            <li><a href="admin-reports.html" class="active">üìä Reports & Analytics</a></li>
            <li><a href="admin-settings.html">‚öôÔ∏è System Settings</a></li>
            <li><a href="#" class="logout-btn">üö™ Logout</a></li>
        </ul>
    </nav>

    <div class="dashboard-container">
        <h1>üìä Reports & Analytics</h1>
        
        <div class="content-grid">
            <!-- Assessment Performance Report -->
            <div class="content-card full-width">
                <div class="card-header blue">
                    <h3>üìà Assessment Performance</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="assessmentTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Assessment Title</th>
                                    <th>Total Marks</th>
                                    <th>Attempts</th>
                                    <th>Avg Score (%)</th>
                                    <th>Max Score (%)</th>
                                    <th>Min Score (%)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- User Activity Report -->
            <div class="content-card">
                <div class="card-header green">
                    <h3>üë• User Activity</h3>
                </div>
                <div class="card-body">
                    <div id="userActivityChart"></div>
                </div>
            </div>

            <!-- Top Performers -->
            <div class="content-card">
                <div class="card-header orange">
                    <h3>üèÜ Top Performers</h3>
                </div>
                <div class="card-body">
                    <div id="topPerformers"></div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-card full-width">
                <div class="card-header red">
                    <h3>üïí Recent Activity</h3>
                </div>
                <div class="card-body">
                    <div id="recentActivity"></div>
                </div>
            </div>

            <!-- Audit Logs -->
            <div class="content-card full-width">
                <div class="card-header purple">
                    <h3>üîç Audit Logs</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="auditTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.requireAuth() || !Auth.hasRole('admin')) {
                window.location.href = 'index.html';
                return;
            }

            document.querySelector('.logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    Auth.logout();
                }
            });

            await loadReports();
            await loadAuditLogs();
        });

        async function loadReports() {
            try {
                const data = await API.getAdminReports();
                
                // Load assessment performance
                loadAssessmentPerformance(data.assessmentPerformance);
                
                // Load user activity
                loadUserActivity(data.userActivity);
                
                // Load top performers
                loadTopPerformers(data.topPerformers);
                
                // Load recent activity
                loadRecentActivity(data.recentActivity);
                
            } catch (error) {
                console.error('Failed to load reports:', error);
                Utils.showAlert('Failed to load reports', 'error');
            }
        }

        function loadAssessmentPerformance(data) {
            const tbody = document.querySelector('#assessmentTable tbody');
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.title}</td>
                    <td>${item.total_marks}</td>
                    <td>${item.attempts || 0}</td>
                    <td>${item.avg_percentage ? parseFloat(item.avg_percentage).toFixed(1) : 'N/A'}</td>
                    <td>${item.max_percentage ? parseFloat(item.max_percentage).toFixed(1) : 'N/A'}</td>
                    <td>${item.min_percentage ? parseFloat(item.min_percentage).toFixed(1) : 'N/A'}</td>
                </tr>
            `).join('');
        }

        function loadUserActivity(data) {
            const container = document.getElementById('userActivityChart');
            container.innerHTML = data.map(item => `
                <div class="activity-item">
                    <div class="role-badge ${item.role}">${item.role}</div>
                    <div class="activity-stats">
                        <div>Attempts: ${item.total_attempts || 0}</div>
                        <div>Avg Performance: ${item.avg_performance ? parseFloat(item.avg_performance).toFixed(1) + '%' : 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadTopPerformers(data) {
            const container = document.getElementById('topPerformers');
            container.innerHTML = data.map((performer, index) => `
                <div class="performer-item">
                    <div class="rank">#${index + 1}</div>
                    <div class="performer-info">
                        <div class="name">${performer.first_name} ${performer.last_name}</div>
                        <div class="stats">
                            <span>Avg: ${parseFloat(performer.avg_score).toFixed(1)}%</span>
                            <span>Tests: ${performer.total_tests}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadRecentActivity(data) {
            const container = document.getElementById('recentActivity');
            container.innerHTML = data.map(activity => `
                <div class="activity-log">
                    <div class="activity-time">${Utils.formatDate(activity.submitted_at)}</div>
                    <div class="activity-details">
                        <strong>${activity.first_name} ${activity.last_name}</strong> 
                        completed <em>${activity.title}</em> 
                        - Score: ${parseFloat(activity.percentage).toFixed(1)}%
                    </div>
                </div>
            `).join('');
        }

        async function loadAuditLogs() {
            try {
                const logs = await API.getAuditLogs();
                const tbody = document.querySelector('#auditTable tbody');
                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${Utils.formatDate(log.created_at)}</td>
                        <td>${log.first_name ? `${log.first_name} ${log.last_name}` : 'System'}</td>
                        <td>${log.action}</td>
                        <td>${log.ip_address || 'N/A'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load audit logs:', error);
            }
        }
    </script>

    <style>
        .full-width { grid-column: 1 / -1; }
        
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        
        .activity-stats {
            margin-left: 1rem;
            font-size: 0.9rem;
        }
        
        .performer-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        
        .rank {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
            margin-right: 1rem;
        }
        
        .performer-info .name {
            font-weight: 600;
        }
        
        .performer-info .stats {
            font-size: 0.8rem;
            color: #666;
        }
        
        .performer-info .stats span {
            margin-right: 1rem;
        }
        
        .activity-log {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .card-header.purple {
            background: linear-gradient(135deg, #6f42c1, #8e44ad);
        }
    </style>
</body>
</html>