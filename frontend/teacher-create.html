<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Assessment - OAS</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <img src="images/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none'">
        </div>
        <ul class="nav-menu">
            <li><a href="teacher-dashboard.html">üè† Home</a></li>
            <li><a href="teacher-assessments.html">üìù My Assessments</a></li>
            <li><a href="teacher-create.html" class="active">‚ûï Create Assessment</a></li>
            <li><a href="teacher-students.html">üë• Students</a></li>
            <li><a href="#" class="logout-btn">üö™ Logout</a></li>
        </ul>
    </nav>

    <div class="dashboard-container">
        <h1>Create New Assessment</h1>
        
        <div class="card">
            <form id="assessmentForm">
                <div class="form-group">
                    <label>Assessment Title</label>
                    <input type="text" id="title" required>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Time Limit (minutes)</label>
                        <input type="number" id="timeLimit" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Course Code</label>
                        <input type="text" id="courseCode">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="negativeMarking"> Negative Marking
                        </label>
                    </div>
                    
                    <div class="form-group" id="negativeMarksGroup" style="display: none;">
                        <label>Negative Marks (0-1)</label>
                        <input type="number" id="negativeMarks" min="0" max="1" step="0.1" value="0.25">
                    </div>
                </div>
                
                <h3>Questions</h3>
                <div id="questionsContainer">
                    <!-- Questions will be added here -->
                </div>
                
                <button type="button" class="btn btn-secondary" onclick="addQuestion()">Add Question</button>
                <button type="submit" class="btn btn-success">Create Assessment</button>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        let questionCount = 0;

        document.addEventListener('DOMContentLoaded', () => {
            if (!Auth.requireAuth() || !Auth.hasRole('teacher')) {
                window.location.href = 'index.html';
                return;
            }

            document.querySelector('.logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    Auth.logout();
                }
            });

            document.getElementById('negativeMarking').addEventListener('change', (e) => {
                document.getElementById('negativeMarksGroup').style.display = 
                    e.target.checked ? 'block' : 'none';
            });

            document.getElementById('assessmentForm').addEventListener('submit', createAssessment);
            
            addQuestion(); // Add first question
        });

        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questionsContainer');
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-block';
            questionDiv.innerHTML = `
                <h4>Question ${questionCount}</h4>
                <div class="form-group">
                    <label>Question Text</label>
                    <textarea name="questionText" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Question Type</label>
                        <select name="questionType" onchange="updateQuestionOptions(this)">
                            <option value="mcq">Multiple Choice</option>
                            <option value="true_false">True/False</option>
                            <option value="short_answer">Short Answer</option>
                            <option value="essay">Essay</option>
                            <option value="fill_blank">Fill in the Blank</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Marks</label>
                        <input type="number" name="marks" min="1" value="2" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select name="difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                
                <div class="options-container">
                    <div class="form-group">
                        <label>Options</label>
                        <input type="text" name="option1" placeholder="Option 1" required>
                        <input type="text" name="option2" placeholder="Option 2" required>
                        <input type="text" name="option3" placeholder="Option 3" required>
                        <input type="text" name="option4" placeholder="Option 4" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Correct Answer</label>
                    <input type="text" name="correctAnswer" required>
                </div>
                
                <button type="button" class="btn btn-danger btn-small" onclick="removeQuestion(this)">Remove Question</button>
                <hr>
            `;
            
            container.appendChild(questionDiv);
        }

        function removeQuestion(button) {
            if (questionCount > 1) {
                button.parentElement.remove();
                questionCount--;
                updateQuestionNumbers();
            }
        }

        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-block h4');
            questions.forEach((h4, index) => {
                h4.textContent = `Question ${index + 1}`;
            });
        }

        function updateQuestionOptions(select) {
            const optionsContainer = select.closest('.question-block').querySelector('.options-container');
            const correctAnswerInput = select.closest('.question-block').querySelector('input[name="correctAnswer"]');
            
            if (select.value === 'true_false') {
                optionsContainer.innerHTML = `
                    <div class="form-group">
                        <label>Options</label>
                        <input type="text" name="option1" value="True" readonly>
                        <input type="text" name="option2" value="False" readonly>
                    </div>
                `;
                correctAnswerInput.placeholder = 'True or False';
            } else if (select.value === 'mcq') {
                optionsContainer.innerHTML = `
                    <div class="form-group">
                        <label>Options</label>
                        <input type="text" name="option1" placeholder="Option 1" required>
                        <input type="text" name="option2" placeholder="Option 2" required>
                        <input type="text" name="option3" placeholder="Option 3" required>
                        <input type="text" name="option4" placeholder="Option 4" required>
                    </div>
                `;
                correctAnswerInput.placeholder = 'Enter correct option text';
            } else {
                optionsContainer.innerHTML = '';
                correctAnswerInput.placeholder = 'Enter correct answer';
            }
        }

        async function createAssessment(e) {
            e.preventDefault();
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                const questions = [];
                
                document.querySelectorAll('.question-block').forEach((block, index) => {
                    const questionData = {
                        questionText: block.querySelector('textarea[name="questionText"]').value,
                        questionType: block.querySelector('select[name="questionType"]').value,
                        marks: parseInt(block.querySelector('input[name="marks"]').value),
                        difficulty: block.querySelector('select[name="difficulty"]').value,
                        correctAnswer: block.querySelector('input[name="correctAnswer"]').value
                    };
                    
                    const options = [];
                    block.querySelectorAll('input[name^="option"]').forEach(input => {
                        if (input.value) options.push(input.value);
                    });
                    
                    if (options.length > 0) {
                        questionData.options = options;
                    }
                    
                    questions.push(questionData);
                });
                
                const assessmentData = {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    timeLimit: parseInt(document.getElementById('timeLimit').value),
                    totalMarks: questions.reduce((sum, q) => sum + q.marks, 0),
                    negativeMarking: document.getElementById('negativeMarking').checked,
                    negativeMarks: document.getElementById('negativeMarking').checked ? 
                        parseFloat(document.getElementById('negativeMarks').value) : 0,
                    courseCode: document.getElementById('courseCode').value,
                    status: 'published',
                    questions: questions
                };
                
                console.log('Sending assessment data:', assessmentData);
                
                const response = await fetch('http://localhost:3000/api/assessments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: JSON.stringify(assessmentData)
                });
                
                const data = await response.json();
                console.log('Response:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create assessment');
                }
                
                alert('Assessment created successfully!');
                window.location.href = 'teacher-dashboard.html';
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating assessment: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Assessment';
            }
        }
    </script>

    <style>
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .question-block {
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .question-block h4 {
            margin-top: 0;
            color: #333;
        }
        .options-container input {
            margin-bottom: 0.5rem;
        }
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
    </style>
</body>
</html>